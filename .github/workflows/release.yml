name: Release

on:
  push:
    branches: [main]

jobs:
  release:
    uses: SylphxAI/.github/.github/workflows/release.yml@main
    with:
      prebuild: bun run build
      postpublish: |
        # Sync NAPI package versions with main package
        VERSION=$(jq -r .version packages/gust/package.json)
        echo "Syncing NAPI packages to version $VERSION"

        # Update main NAPI package.json
        cd crates/gust-napi
        jq ".version = \"$VERSION\"" package.json > tmp.json && mv tmp.json package.json

        # Update optionalDependencies versions
        jq ".optionalDependencies = (.optionalDependencies | to_entries | map(.value = \"$VERSION\") | from_entries)" package.json > tmp.json && mv tmp.json package.json

        # Update all platform package.json files
        for dir in npm/*/; do
          if [ -f "$dir/package.json" ]; then
            jq ".version = \"$VERSION\"" "$dir/package.json" > tmp.json && mv tmp.json "$dir/package.json"
            echo "Updated $dir to version $VERSION"
          fi
        done

        # Trigger NAPI publish workflow
        gh workflow run napi.yml -f publish=true
    secrets: inherit
